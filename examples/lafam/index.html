<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LaFAM Live Demo</title>

    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <section id="main-section" class="main-section paused">
        <!-- Canvas Area -->
        <div class="canvas-block" id="canvas-area">
            <div class="canvas-wrapper">
                <div id="loading-indicator" class="loading">
                    <img src="assets/images/loading.svg" alt="Loading animation" />
                    <div id="loading-text">Initializing...</div>
                </div>
                <canvas id="img-canvas" width="1024" height="1024"></canvas>
                <canvas id="heatmap-canvas" width="1024" height="1024"></canvas>
                <canvas id="bounding-boxes-canvas" width="1024" height="1024"></canvas>
                <div id="grid"></div>
            </div>
        </div>

        <div class="record-block">
            <!-- Controls -->
            <div class="card" id="control-panel">
                <div class="button-group">
                    <button id="start-button" class="btn" disabled title="Start/Pause Camera"
                        aria-label="Start or pause camera stream">
                        <img src="assets/images/play.svg" class="icon play-icon" alt="Play icon" />
                        <img src="assets/images/pause.svg" class="icon pause-icon" alt="Pause icon" />
                    </button>
                    <button id="switch-camera-button" class="btn" title="Switch Camera"
                        aria-label="Switch between available cameras">
                        <img src="assets/images/switch-camera.svg" class="icon" alt="Switch camera icon" />
                    </button>
                    <!-- Slim Split-Button for Upload & Presets -->
                    <div class="btn upload-split-group" id="upload-group">
                        <!-- Left: Upload Trigger -->
                        <div id="upload-button" class="split-action" title="Upload Image or Video"
                            aria-label="Upload an image or video from your device">
                            <img src="assets/images/upload.svg" class="icon" alt="Upload icon" />
                        </div>
                        <input type="file" id="upload-input" accept="image/*,video/*" style="display: none;">

                        <!-- Divider -->
                        <div class="split-divider"></div>

                        <!-- Right: Preset Dropdown -->
                        <div class="split-action relative" title="Select Preset">
                            <!-- Visual Arrow -->
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M7 10l5 5 5-5z" />
                            </svg>
                            <!-- Invisible Select sitting on top -->
                            <select id="predefined-files" class="invisible-select lafam-select">
                                <option value="" disabled selected hidden></option> <!-- Empty Selection -->
                                <option value="images/dog_and_cat.jpg">üñºÔ∏è Dog & Cat</option>
                                <option value="images/self-driving.png">üñºÔ∏è Self-driving car</option>
                                <option value="images/misc.png">üñºÔ∏è Misc</option>
                                <option value="videos/dog_on_a_beach.mp4">üé• Dog on a beach</option>
                            </select>
                        </div>
                    </div>

                    <button id="theme-toggle-button" class="btn" title="Toggle Theme"
                        aria-label="Toggle between light and dark theme">
                        <!-- Moon Icon (Visible in Light Mode) -->
                        <svg class="icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <!-- Sun Icon (Visible in Dark Mode) -->
                        <svg class="icon sun-icon" viewBox="0 0 24 24">
                            <path
                                d="M6.995 12c0 2.761 2.246 5.007 5.007 5.007s5.007-2.246 5.007-5.007-2.246-5.007-5.007-5.007S6.995 9.239 6.995 12zM11 19h2v3h-2zm0-17h2v3h-2zm-9 9h3v2h-3zm17 0h3v2h-3zM5.637 19.778l-1.414-1.414 2.121-2.121 1.414 1.414zM16.242 6.344l2.122-2.122 1.414 1.414-2.122 2.122zM6.344 7.759 4.223 5.637l1.415-1.414 2.12 2.122zM19.07 18.365l1.414 1.414-2.122 2.122-1.414-1.414z" />
                        </svg>
                    </button>

                    <button id="help-button" class="btn help" title="Start Tutorial"
                        aria-label="Start interactive tutorial">
                        ?
                    </button>
                </div>
                <div class="select-wrapper">
                    <select id="mode-select" class="lafam-select">
                        <option value="predict" selected>Classifier with LaFAM/GradCAM</option>
                        <option value="imagenet_classes">Multi-instance classification</option>
                        <option value="groupmap_bbs">Object detection</option>
                        <option value="object_tracking">Object tracking</option>
                    </select>
                    <select id="palette-select" class="lafam-select">
                    </select>
                </div>
                <div id="slider-container">
                    <div class="slider-label">
                        <label for="heatmap-opacity">Heatmap Opacity</label>
                    </div>
                    <input type="range" id="heatmap-opacity" min="0.0" max="1.0" value="0.5" step="0.05">
                </div>

                <!-- Object Tracking Controls -->
                <div id="tracking-controls" class="hidden">
                    <div class="control-group">
                        <button id="add-object-btn" class="btn primary full-width">
                            + Add Object
                        </button>
                    </div>
                    
                    <div id="tracking-objects-list">
                        <!-- Object items will be added here dynamically -->
                    </div>

                    <div class="control-divider"></div>

                    <div class="control-group">
                        <label for="tracking-resolution">Resolution</label>
                        <select id="tracking-resolution" class="lafam-select small">
                            <option value="224" selected>224x224 (High)</option>
                            <option value="112">112x112 (Mid)</option>
                            <option value="56">56x56 (Low)</option>
                        </select>
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <label for="tracking-threshold">Similarity Threshold</label>
                            <span id="tracking-threshold-val">0.50</span>
                        </div>
                        <input type="range" id="tracking-threshold" min="0.0" max="1.0" value="0.5" step="0.05">
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <label for="tracking-ema">Smoothing (EMA)</label>
                            <span id="tracking-ema-val">0.75</span>
                        </div>
                        <input type="range" id="tracking-ema" min="0.0" max="1.0" value="0.75" step="0.05">
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <label for="tracking-overlay-alpha">Overlay Alpha</label>
                            <span id="tracking-overlay-alpha-val">0.50</span>
                        </div>
                        <input type="range" id="tracking-overlay-alpha" min="0.0" max="1.0" value="0.5" step="0.05">
                    </div>
                </div>
            </div>

            <!-- Predictions -->
            <div class="predictions-container card" id="predictions-panel">
                <div class="prediction-title">
                    <div>Predictions</div>
                    <button id="clear-selection" disabled title="Clear selection" aria-label="Clear all selections">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                    </button>
                </div>
                <div id="prediction-list">
                    <div class="prediction-placeholder"><span>Ready to analyze</span></div>
                </div>
            </div>
        </div>
    </section>

    <section class="info-section">
        <h2>About</h2>
        <p>This interactive demo showcases the Label-free Activation Map for Convolutional Neural Networks. It uses a
            ResNet50 model trained on the ImageNet dataset (<a href="#" onclick="return false;">1000 categories</a>) and
            generates heatmaps from the model's final convolutional layer without relying on labels.</p>
        <h3>Interactions</h3>
        <p>Use your camera, upload an image, or select a pre-defined image from the dropdown menu.</p>
        <ul>
            <li><strong>Pause Camera:</strong> Essential for interacting with the grid.</li>
            <li><strong>Grid Click:</strong> Click on specific image regions to see what the model focused on.</li>
            <li><strong>Prediction Click:</strong> Click a class name to highlight where that object was detected. Clear
                selection by clicking again or clicking the X-button.</li>
            <li><strong>Mode Selection:</strong> Choose different model modes to switch between label-free/Grad-CAM
                heatmaps, multi-instance classification, and object detection.</li>
        </ul>
    </section>

    <section id="debug-section" class="debug-section">
        <h3>Debug Log</h3>
        <p>If you encounter issues, use the hard reset button below to clear cache and manually reload the page.</p>
        <button onclick="updateServiceWorker()" style="margin-bottom: 10px; cursor: pointer;">Hard reset</button>
        <h4>Available devices</h4>
        <textarea id="devices" style='width: 100%;' rows='10' disabled></textarea>
        <h3>Log</h3>

        <textarea id='log' rows='10' disabled></textarea>
    </section>

    <!-- TUTORIAL OVERLAY ELEMENTS -->
    <div id="tutorial-overlay">
        <div id="tutorial-spotlight" class="animating"></div>
        <div id="tutorial-card">
            <h3 id="tut-title">Title</h3>
            <p id="tut-desc">Description goes here.</p>
            <div class="tutorial-controls">
                <button id="tut-skip" class="tut-btn">Skip</button>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-variant-numeric: tabular-nums;">
                    <span id="tut-step">1</span> of <span id="tut-total">4</span>
                </div>
                <button id="tut-next" class="tut-btn tut-btn-primary">Next</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/ui.js"></script>
    <script src="js/boundingboxes.js"></script>
    <script src="js/app.js"></script>
</body>

</html>