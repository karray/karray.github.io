<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LaFAM Live Demo</title>

    <link rel="stylesheet" href="index.css">
</head>

<body>

    <section id="main-section" class="main-section paused">
        <!-- Canvas Area -->
        <div class="canvas-block" id="canvas-area">
            <div class="canvas-wrapper">
                <div id="loading-indicator" class="loading">
                    <img src="loading.svg" class="icon"
                        style="animation: spin 1s linear infinite; width: 10vh; height: 10vh;" />
                    <div id="loading-text" style="margin-top:10px;">Initializing...</div>
                </div>
                <canvas id="img-canvas" width="1024" height="1024"></canvas>
                <canvas id="heatmap-canvas" width="1024" height="1024"></canvas>
                <canvas id="bounding-boxes-canvas" width="1024" height="1024"></canvas>
                <div id="grid"></div>
            </div>
        </div>

        <div class="record-block">
            <!-- Controls -->
            <div class="card" id="control-panel">
                <div class="button-group">
                    <button id="start-button" class="btn" disabled title="Start/Pause Camera">
                        <img src="play.svg" class="icon play-icon" />
                        <img src="pause.svg" class="icon pause-icon" style="display:none;" />
                    </button>
                    <button id="switch-camera-button" class="btn" disabled title="Switch Camera">
                        <img src="switch-camera.svg" class="icon" />
                    </button>
                    <!-- Slim Split-Button for Upload & Presets -->
                    <div class="btn upload-split-group" id="upload-group">
                        <!-- Left: Upload Trigger -->
                        <div id="upload-button" class="split-action" title="Upload Image">
                            <img src="upload.svg" class="icon" />
                        </div>
                        <input type="file" id="upload-input" accept="image/*" style="display: none;">

                        <!-- Divider -->
                        <div class="split-divider"></div>

                        <!-- Right: Preset Dropdown -->
                        <div class="split-action relative" title="Select Preset">
                            <!-- Visual Arrow -->
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M7 10l5 5 5-5z" />
                            </svg>
                            <!-- Invisible Select sitting on top -->
                            <select id="predefined-files" class="invisible-select lafam-select">
                                <option value="" disabled selected hidden></option> <!-- Empty Selection -->
                                <option value="dog_and_cat.jpg">Dog & Cat</option>
                                <option value="self-driving.png">Self-driving car</option>
                                <option value="misc.png">Misc</option>
                            </select>
                        </div>
                    </div>
                    <!-- <label class="theme-switch" for="checkbox">
                        <input type="checkbox" id="checkbox" />
                        <div class="slider"></div>
                    </label> -->

                    <button id="theme-toggle-button" class="btn"
                        title="Toggle Theme">
                        <!-- Moon Icon (Visible in Light Mode) -->
                        <svg class="icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <!-- Sun Icon (Visible in Dark Mode) -->
                        <svg class="icon sun-icon" viewBox="0 0 24 24">
                            <path
                                d="M6.995 12c0 2.761 2.246 5.007 5.007 5.007s5.007-2.246 5.007-5.007-2.246-5.007-5.007-5.007S6.995 9.239 6.995 12zM11 19h2v3h-2zm0-17h2v3h-2zm-9 9h3v2h-3zm17 0h3v2h-3zM5.637 19.778l-1.414-1.414 2.121-2.121 1.414 1.414zM16.242 6.344l2.122-2.122 1.414 1.414-2.122 2.122zM6.344 7.759 4.223 5.637l1.415-1.414 2.12 2.122zM19.07 18.365l1.414 1.414-2.122 2.122-1.414-1.414z" />
                        </svg>
                    </button>

                    <button id="help-button" class="btn help" title="Start Tutorial">
                        ?
                    </button>
                </div>
                <div class="select-wrapper">
                    <select id="palette-select" class="lafam-select">
                    </select>
                    <select id="mode-select" class="lafam-select">
                        <option value="predict" selected>Classifier with LaFAM/GradCAM</option>
                        <option value="imagenet-classes">Multi-instance classification</option>
                        <option value="groupmap-bbs">Object detection</option>
                    </select>
                </div>
                <div id="slider-container">
                    <div
                        style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px; color: var(--text-muted);">
                        <label for="heatmap-opacity">Heatmap Opacity</label>
                    </div>
                    <input type="range" id="heatmap-opacity" min="0.0" max="1.0" value="0.5" step="0.05">
                </div>
            </div>

            <!-- Predictions -->
            <div class="predictions-container card" id="predictions-panel">
                <div class="prediction-title">
                    <div>Predictions</div>
                    <button id="clear-selection" disabled title="Clear selection">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                    </button>
                </div>
                <div id="prediction-list">
                    <div class="prediction" style="color: var(--text-muted); justify-content: center;"><span>Ready to
                            analyze</span></div>
                </div>
            </div>
        </div>
    </section>

    <section class="info-section">
        <h2>About</h2>
        <p>This interactive demo showcases the Label-free Activation Map for Convolutional Neural Networks. It uses a
            ResNet50 model trained on the ImageNet dataset (<a href="#" onclick="return false;">1000 categories</a>) and
            generates heatmaps from the model's final convolutional layer without relying on labels.</p>
        <h3>Interactions</h3>
        <p>Use your camera, upload an image, or select a pre-defined image from the dropdown menu.</p>
        <ul>
            <li><strong>Pause Camera:</strong> Essential for interacting with the grid.</li>
            <li><strong>Grid Click:</strong> Click on specific image regions to see what the model focused on.</li>
            <li><strong>Prediction Click:</strong> Click a class name to highlight where that object was detected. Clear
                selection by clicking again or clicking the X-button.</li>
            <li><strong>Mode Selection:</strong> Choose different model modes to switch between label-free/Grad-CAM
                heatmaps, multi-instance classification, and object detection.</li>
        </ul>
    </section>

    <section id="debug-section" class="debug-section">
        <h3>Debug Log</h3>
        <p>If you encounter issues, use the hard reset button below to clear cache and manually reload the page.</p>
        <button onclick="updateServiceWorker()" style="margin-bottom: 10px; cursor: pointer;">Hard reset</button>
        <h4>Available devices</h4>
        <textarea id="devices" style='width: 100%;' rows='10' disabled></textarea>
        <h3>Log</h3>

        <textarea id='log' rows='10' disabled></textarea>
    </section>

    <!-- TUTORIAL OVERLAY ELEMENTS -->
    <div id="tutorial-overlay">
        <div id="tutorial-spotlight" class="animating"></div>
        <div id="tutorial-card">
            <h3 id="tut-title">Title</h3>
            <p id="tut-desc">Description goes here.</p>
            <div class="tutorial-controls">
                <button id="tut-skip" class="tut-btn">Skip</button>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-variant-numeric: tabular-nums;">
                    <span id="tut-step">1</span> of <span id="tut-total">4</span>
                </div>
                <button id="tut-next" class="tut-btn tut-btn-primary">Next</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. THEME LOGIC ---
        const themeBtn = document.getElementById('theme-toggle-button');
        const currentTheme = localStorage.getItem('theme');

        // Initial Load
        if (currentTheme) {
            document.body.className = currentTheme;
        } else {
            // System preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.className = 'dark-mode';
            }
        }

        // Toggle Event
        themeBtn.addEventListener('click', function() {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light-mode');
            } else {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark-mode');
            }
        });

        // --- 2. TUTORIAL LOGIC (SIDE POSITIONING) ---
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const spotlight = document.getElementById('tutorial-spotlight');
        const card = document.getElementById('tutorial-card');

        const titleEl = document.getElementById('tut-title');
        const descEl = document.getElementById('tut-desc');
        const nextBtn = document.getElementById('tut-next');
        const skipBtn = document.getElementById('tut-skip');
        const stepEl = document.getElementById('tut-step');
        const totalEl = document.getElementById('tut-total');

        const steps = [
            { target: '#control-panel', title: "Control Center", desc: "Manage the camera, upload images, change mode, or adjust settings here. You can fine-tune the visualization mode and opacity." },
            { target: '#upload-group', title: "Upload & Presets", desc: "Upload your own image or choose from our preset scenarios" },
            { target: '#mode-select', title: "Model Modes", desc: "Select different model modes: defalut ResNet with label-free/Grad-CAM heatmaps, Multi-instance classification, object detection" },
            { target: '#predictions-panel', title: "Predictions", desc: "The model's top guesses appear here. Click a prediction to highlight the area in the image responsible for that classification. You can clear selection by clicking again or clicking X-button." },
            { target: '#canvas-area', title: "Live Visualization", desc: "This canvas displays the model's salience map. Pause the stream to interact with the overlay Grid and explore specific regions. You can click on grid cells to show predictions for that region (multiple cells selection possible)." },
        ];

        let currentStepIndex = 0;

        function updateSpotlightPosition() {
            // Update overlay height for scrolling
            tutorialOverlay.style.height = document.documentElement.scrollHeight + 'px';

            const step = steps[currentStepIndex];
            const targetEl = document.querySelector(step.target);
            if (!targetEl) return;

            const rect = targetEl.getBoundingClientRect(); // Viewport relative
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            const padding = 6;

            // Absolute Coords
            const absTop = rect.top + scrollTop - padding;
            const absLeft = rect.left + scrollLeft - padding;
            const width = rect.width + (padding * 2);
            const height = rect.height + (padding * 2);

            // Set Spotlight
            spotlight.style.width = width + 'px';
            spotlight.style.height = height + 'px';
            spotlight.style.top = absTop + 'px';
            spotlight.style.left = absLeft + 'px';

            // --- SMART POSITIONING ---
            // We want to place the card to the RIGHT if there is space, otherwise Bottom, etc.

            const cardWidth = 340; // Approx card width
            const cardGap = 20;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            // Check Available Space relative to viewport
            const spaceRight = windowWidth - rect.right;
            const spaceLeft = rect.left;
            const spaceBottom = windowHeight - rect.bottom;

            // Logic:
            // 1. If mobile (<900px), use CSS Fixed positioning (do nothing here regarding top/left).
            // 2. If space on RIGHT > cardWidth, place Right.
            // 3. Else if space on LEFT > cardWidth, place Left.
            // 4. Else place Bottom.
            // 5. If not enough space Bottom, place Top.

            if (windowWidth < 900) {
                // Mobile: Reset inline styles so CSS handles it
                card.style.top = '';
                card.style.left = '';
                card.style.transform = '';
            } else {
                // Desktop
                let finalLeft, finalTop;

                // Priority 1: Right Side
                if (spaceRight > (cardWidth + cardGap)) {
                    finalLeft = absLeft + width + cardGap;
                    finalTop = absTop; // Align Top edges
                }
                // Priority 2: Left Side
                else if (spaceLeft > (cardWidth + cardGap)) {
                    finalLeft = absLeft - cardWidth - cardGap;
                    finalTop = absTop;
                }
                // Priority 3: Bottom
                else {
                    finalLeft = absLeft; // Align Left edges
                    if (spaceBottom > 250) {
                        finalTop = absTop + height + cardGap; // Below
                    } else {
                        finalTop = absTop - 250; // Above (approx height)
                    }
                }

                // Boundaries Check (keep inside document)
                if (finalLeft + cardWidth > document.documentElement.scrollWidth) {
                    finalLeft = document.documentElement.scrollWidth - cardWidth - 10;
                }
                if (finalLeft < 10) finalLeft = 10;

                card.style.left = finalLeft + 'px';
                card.style.top = finalTop + 'px';
            }

            card.classList.add('visible');
        }

        function setStepContent() {
            const step = steps[currentStepIndex];
            titleEl.innerText = step.title;
            descEl.innerText = step.desc;
            stepEl.innerText = currentStepIndex + 1;
            totalEl.innerText = steps.length;
            nextBtn.innerText = (currentStepIndex === steps.length - 1) ? "Finish" : "Next";
        }

        function goToStep(index) {
            currentStepIndex = index;
            setStepContent();

            const targetEl = document.querySelector(steps[index].target);
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Delay to allow scroll to settle
            setTimeout(updateSpotlightPosition, 150);
            setTimeout(updateSpotlightPosition, 400);
        }

        function startTutorial() {
            currentStepIndex = 0;
            tutorialOverlay.classList.add('active');
            goToStep(0);
        }
        function endTutorial() {
            card.classList.remove('visible');
            setTimeout(() => { tutorialOverlay.classList.remove('active'); }, 300);
            localStorage.setItem('lafam_tutorial_shown', 'true');
        }

        nextBtn.addEventListener('click', () => {
            if (currentStepIndex < steps.length - 1) goToStep(currentStepIndex + 1);
            else endTutorial();
        });
        skipBtn.addEventListener('click', endTutorial);
        document.getElementById('help-button').addEventListener('click', startTutorial);

        window.addEventListener('resize', () => {
            if (tutorialOverlay.classList.contains('active')) updateSpotlightPosition();
        });

        window.addEventListener('load', () => {
            const styleSheet = document.createElement("style");
            styleSheet.innerText = `@keyframes spin { 100% { transform: rotate(360deg); } }`;
            document.head.appendChild(styleSheet);
            if (!localStorage.getItem('lafam_tutorial_shown')) setTimeout(startTutorial, 1000);
        });
    </script>
    <script src="boundingboxes.js"></script>
    <script src="index.js"></script>
</body>

</html>